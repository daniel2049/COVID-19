<!DOCTYPE html>
<html>
<head>
<style>
table#t01 td {
  table-layout: fixed;
  border: 1px solid black;
}
div#d01 {
    display: flex;
    flex-flow: row-reverse;
    align-items: center;
    justify-content: flex-end;
    height: 30px;
}
.lblFloat
{
    float:right;
    text-align: center;
    padding-left: 1em;
}
H2 {
    margin: 0px;
}
</style>
</head>
<body>

<H2 align="center">COVID-19 Cases in U.S.</H2>
<object id="svg-object" width="90%" type="image/svg+xml" data="USA_Counties_with_FIPS_and_names.svg" ></object>

    <script type="text/javascript" src="data/base_info.txt"></script>
    <script type="text/javascript">
      function resize_map(S, state) {
	var region_box = {'USA':"0 0 555 352", 'Alabama':"280 170 225 143", 'Alaska':"-30 220 225 143", 'Arizona':"30 130 225 143", 'Arkansas':"220 140 225 143", 'California':"-50 82 225 143", 'Colorado':"80 70 225 143", 'Connecticut':"400 10 225 143", 'Delaware':"380 60 225 143", 'District of Columbia':"350 60 225 143", 'Florida':"300 220 225 143", 'Georgia':"300 190 225 143", 'Hawaii':"80 250 225 143", 'Idaho':"20 -10 225 143", 'Illinois':"230 70 225 143", 'Indiana':"280 70 225 143", 'Iowa':"200 40 225 143", 'Kansas':"140 90 225 143", 'Kentucky':"280 90 225 143", 'Louisiana':"220 190 225 143", 'Maine':"400 -30 225 143", 'Maryland':"350 60 225 143", 'Massachusetts':"400 0 225 143", 'Michigan':"270 20 225 143", 'Minnesota':"200 -10 225 143", 'Mississippi':"260 170 225 143", 'Missouri':"210 90 225 143", 'Montana':"40 -20 225 143", 'Nebraska':"135 50 225 143", 'Nevada':"0 70 225 143", 'New Hampshire':"400 -10 225 143", 'New Jersey':"380 20 225 143", 'New Mexico':"80 130 225 143", 'New York':"360 0 225 143", 'North Carolina':"320 130 225 143", 'North Dakota':"135 -20 225 143", 'Ohio':"300 60 225 143", 'Oklahoma':"140 130 225 143", 'Oregon':"-30 -10 225 143", 'Pennsylvania':"360 50 225 143", 'Rhode Island':"400 10 225 143", 'South Carolina':"320 160 225 143", 'South Dakota':"135 10 225 143", 'Tennessee':"280 120 225 143", 'Texas':"140 190 225 143", 'Utah':"30 70 225 143", 'Vermont':"380 -10 225 143", 'Virginia':"320 90 225 143", 'Washington':"-30 -40 225 143", 'West Virginia':"320 90 225 143", 'Wisconsin':"230 10 225 143", 'Wyoming':"70 20 225 143"};
        e = S.getElementById('svg9559');
        e.setAttribute("viewBox", region_box[state]);
      }

      var first_flag = 1;
      var svg_title = [];
      function OBJECT(D){
        try {S=D.getSVGDocument()}
        catch(e){S=D.contentDocument}
        return S
      }
      function case_to_percent(num) {
        var p;
        var scaled_p;
        if (num >= 1 && num <= 100) {
          p = (num/100.0)*20.0;
        } else if (num >= 101 && num <= 1000) {
          p = 20.0 + ((num-100.0)/900.0)*20.0;
        } else if (num >= 1001 && num <= 5000) {
          p = 40.0 + ((num-1000.0)/4000.0)*20.0;
        } else if (num >= 5001 && num <= 10000) {
          p = 60.0 + ((num-5000.0)/5000.0)*20.0;
        } else if (num >= 10001) {
          p = 80.0 + ((num-10000.0)/20000.0)*20.0;
        } else {
          return 0;
        }
        if (p > 100.0) {
           p = 100.0
        }
        return (5.0 + (100.0 - p)*85.0/100.0);
      }
      function fill_color(S, fips_cases1, fips_death1, fips_cases2, fips_death2) {
        for (var k in fips_cases1) {
           try { 
              e = S.getElementById(k)
              var delta_cases;
              if (fips_cases2 != null) {
                 delta_cases = fips_cases1[k] - fips_cases2[k];
              } else {
                 delta_cases = fips_cases1[k];
              }
              var delta_death;
              if (fips_death2 != null) {
                 delta_death = fips_death1[k] - fips_death2[k];
              } else {
                 delta_death = fips_death1[k];
              }
              var p = case_to_percent(delta_cases);
              var color;
              if (p > 0) {
                 color = 'hsl(0, 100%,' + p.toString()+'%)';
              } else {
                 color = "#d0d0d0";
              }
              e.setAttributeNS(null, 'fill', color);
              if (first_flag == 1) {
                 svg_title[k] = e.children[0].innerHTML;
              }
              var title_case = svg_title[k] + '\n' + 'cases: ' + delta_cases.toString() + '\n' + 'death: ' + delta_death.toString()
              //var title_id = e.children[0].id
              //e.innerHTML = "\n   <title xmlns=\"http://www.w3.org/2000/svg\" id=\"" + title_id + "\">" + title_case + "</title>\n  "
              e.innerHTML = "\n   <title xmlns=\"http://www.w3.org/2000/svg\">" + title_case + "</title>\n  "
           }
           catch(e){ continue; }
        }
        first_flag = 0;
      }
      function read_cases1(id) {
         var slider = document.getElementById("myRange");
         var day = parseInt(slider.value);
         var num_day_inc = document.getElementById("num_day_inc").value

         var start_day = document.getElementById("startDay");
         var end_day = document.getElementById("endDay");
         if (day >= num_day_inc) {
            start_day.innerHTML = day_slide[day-num_day_inc]
         } else {
            start_day.innerHTML = day_slide[0]
         }
         end_day.innerHTML = day_slide[day]

         var xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() {
           if (this.readyState == 4 && this.status == 200) {
             var obj = JSON.parse(this.responseText);
             var fips_cases = obj.fips_cases
             var fips_death = obj.fips_death
             var county_cases = obj.county_cases
             if (day >= num_day_inc) {
                read_cases2(id, day, num_day_inc, county_cases, fips_cases, fips_death);
             } else {
                update_map(id, day, num_day_inc, county_cases, null, fips_cases, fips_death);
             }
           }
         };
         xhttp.open("GET", "/COVID-19/data2/case_" + day_slide[day] + ".txt", true);
         xhttp.send();
      }
      function read_cases2(id, day, num_day_inc, county_cases1, fips_cases1, fips_death1) {
         var xhttp = new XMLHttpRequest();
         xhttp.onreadystatechange = function() {
           if (this.readyState == 4 && this.status == 200) {
             var obj = JSON.parse(this.responseText);
             var fips_cases = obj.fips_cases
             var fips_death = obj.fips_death
             var county_cases = obj.county_cases
             update_map(id, day, num_day_inc, county_cases1, county_cases, fips_cases1, fips_death1, fips_cases, fips_death);
           }
         };
         xhttp.open("GET", "/COVID-19/data2/case_" + day_slide[day-num_day_inc] + ".txt", true);
         xhttp.send();
      }
      function update_map(id, day, num_day_inc, county_cases1, county_cases2, fips_cases1, fips_death1, fips_cases2, fips_death2) {
        var D=document.getElementById(id)
	S=eval(D.nodeName)(D,id) //sends OBJECT to function OBJECT, EMBED to EMBED etc.
	if (!S) return

        var state = document.getElementById("choose-state").value
        // Create items array
        var top_county = Object.keys(county_cases1[state]).map(function(key) {
           if (county_cases2 != null) {
              return [key, county_cases1[state][key]-county_cases2[state][key]];
           } else {
              return [key, county_cases1[state][key]];
           }
        });

        resize_map(S, state);

        // Sort the array based on the second element
        top_county.sort(function(first, second) {
  	   if (first[1] > second[1]) return -1;
	   else return 1;
        });
        var last_found = -1
        var n;
        if (top_county.length >= 10) n = 10;
        else n = top_county.length;
        for (var i = 0; i < n; i=i+1) {
           var k = top_county[i][0];
           document.getElementById("top_name["+i.toString()+"]").innerHTML  = k
           var delta = 0;
           if (county_cases2 != null) {
              delta = county_cases1[state][k] - county_cases2[state][k];
           } else {
              delta = county_cases1[state][k]
           }
           document.getElementById("top_value["+i.toString()+"]").innerHTML = delta
           if (i > last_found) {  // async
              last_found = i;
           }
        }
        for (var i = last_found + 1; i < 10; i++) {
           document.getElementById("top_name["+i.toString()+"]").innerHTML  = '-'
           document.getElementById("top_value["+i.toString()+"]").innerHTML = '-'
        }
        fill_color(S, fips_cases1, fips_death1, fips_cases2, fips_death2);
      }
    </script>

<div id="d01">
 <svg width="749.55" height="15" >
 <text x="100" y="10" font-family="sans-serif" font-size="10px" fill="black">1</text>
 <rect x="100" y="12" width="50" height="3" style="fill:hsl(0, 100%, 90%)"></rect>
 <text x="150" y="10" font-family="sans-serif" font-size="10px" fill="black">101</text>
 <rect x="150" y="12" width="50" height="3" style="fill:hsl(0, 100%, 73%)"></rect>
 <text x="200" y="10" font-family="sans-serif" font-size="10px" fill="black">1001</text>
 <rect x="200" y="12" width="50" height="3" style="fill:hsl(0, 100%, 56%)"></rect>
 <text x="250" y="10" font-family="sans-serif" font-size="10px" fill="black">5001</text>
 <rect x="250" y="12" width="50" height="3" style="fill:hsl(0, 100%, 39%)"></rect>
 <text x="300" y="10" font-family="sans-serif" font-size="10px" fill="black">10001+</text>
 <rect x="300" y="12" width="50" height="3" style="fill:hsl(0, 100%, 22%)"></rect>
</svg>
    <output class="lblFloat"></output>
    <input type="range" id="myRange" min="0" max="100" oninput="read_cases1('svg-object')" />
    <label>Time Lapse:</label>
</div>

<div>
<label for "state">New cases in </label>
<select id="choose-state" oninput=read_cases1('svg-object')>
</select>
<label> in </label>
<select id="num_day_inc" oninput=read_cases1('svg-object')>
  <option value=Infinity>all</option>
  <option value=3>3</option>
  <option value=7>7</option>
  <option value=14>14</option>
</select>
<label> days from <span id="startDay"></span> to <span id="endDay"></span><label>
</div>
<script>
   function add_element(state) {
      var option = document.createElement('option');
      option.text = state
      option.value = state
      document.querySelector('#choose-state').add(option, null);
   }
   for (var i = 0; i < num_state; i++) {
      add_element(state_name[i])
   }
</script>


<div>
<font size="3" >
<table id="t01">
  <tr>
  <script>
  for (var i = 0; i < 5; i++) {
     document.writeln('<col width="100px" />')
     document.writeln('<col width="70px" />')
  }
  for (var i = 0; i < 5; i++) {
     document.writeln('<td align="center"><span id="top_name[' + i.toString() + ']">-</span></td>')
     document.writeln('<td align="center"><span id="top_value[' + i.toString() + ']">-</span></td>')
  }
  </script>
  </tr>
  <tr>
  <script>
  for (var i = 5; i < 10; i++) {
     document.writeln('<td align="center"><span id="top_name[' + i.toString() + ']">-</span></td>')
     document.writeln('<td align="center"><span id="top_value[' + i.toString() + ']">-</span></td>')
  }
  </script>
  </tr>
</table>
</div>

<script>
var slider = document.getElementById("myRange");
slider.max = (num_case-1).toString();
slider.value = (num_case-1).toString();
</script>

<script>
  window.onload = function() {
    read_cases1('svg-object')
  };
</script>

<div>
<br>
<p> SOURCES:<br>
1) <a href="https://github.com/CSSEGISandData/COVID-19">CSSEGISandData/COVID-19<br></a>
2) <a href="https://commons.wikimedia.org/wiki/File:USA_Counties.svg">File:USA Counties.svg</a>
</p>
</div>

</body>
</html>
